rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper functions =========

    function isSignedIn() {
      return request.auth != null;
    }

    // Safe accessor for current user's Firestore doc
    // Note: Only call this after checking hasUserDoc() to avoid errors
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasUserDoc() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Safe role getter - returns null if doc doesn't exist or role field is missing
    function getUserRole() {
      return hasUserDoc() ? userDoc().data.role : null;
    }

    // Role helpers. Only two roles: super_admin and admin. Positions (e.g. official, staff) are labels only.
    function role() {
      return getUserRole();
    }

    // Only Super Admin has full access (Approvals, User Management, adminSettings, etc.)
    function isSuperAdmin() {
      return hasUserDoc() &&
        getUserRole() == 'super_admin';
    }
	
  	// ========= adminSettings =========
    // Stores panel-wide flags such as auto-approve settings.
    match /adminSettings/{docId} {
      // Only Super Admin can read/write these settings.
      allow read, write: if isSuperAdmin();
    }
    
    
    // Any admin-panel account (can log into Windows app). Only two roles: super_admin and admin.
    function isAdminPanelUser() {
      return hasUserDoc() &&
        getUserRole() in ['super_admin', 'admin'];
    }

    // ========= users collection =========

    match /users/{userId} {
      // SUPER ADMIN: full access to all profiles
      allow read, write: if isSuperAdmin();

      // Owner: can read and update own profile (includes declined users re-applying: accountStatus, proofOfResidenceUrl, etc.)
      allow read, update: if isSignedIn() && request.auth.uid == userId;

      // Only Super Admin can read other users (User Management). Admin is limited to Dashboard and Announcements.
      allow read: if isSuperAdmin();

      // Create user docs: only Super Admin
      allow create: if isSuperAdmin();

      // Devices subcollection: FCM tokens
      match /devices/{deviceId} {
        // Owner can manage own devices
        allow read, write: if isSignedIn() && request.auth.uid == userId;

        // SUPER ADMIN may need to inspect devices (optional)
        allow read: if isSuperAdmin();
      }
    }

    // ========= awaitingApproval =========
    // Sign-up / verification requests (mobile creates without Auth; Super Admin approves later)

    match /awaitingApproval/{docId} {
      // Only Super Admin can list/read all. Applicant can read their own doc.
      allow read: if isSuperAdmin()
        || (isSignedIn() && resource.data.requestedByUid == request.auth.uid);

      // Mobile create-account does NOT sign in first — allow unauthenticated create so registration works
      allow create: if true;

      // Update: only Super Admin or the applicant (e.g. add fcmTokens)
      allow update: if isSuperAdmin()
        || (isSignedIn() && resource.data.requestedByUid == request.auth.uid);

      // Delete: Super Admin (approve/decline flow) or applicant (original email-style mapping)
      allow delete: if isSuperAdmin()
        || (isSignedIn()
          && request.auth.token.email == (resource.data.phoneNumber + '@linkod.com'));
    }

    // ========= announcements =========

    match /announcements/{docId} {
      // Any signed-in user can read announcements
      allow read: if isSignedIn();

      // Create: Super Admin and Admin can create (Admin submissions need approval; app logic)
      allow create: if isAdminPanelUser();

      // Update:
      // - SUPER ADMIN can fully update (approve/decline, edit)
      allow update: if isSuperAdmin();

      // Special case: legacy behavior where non-admins update only viewCount/updatedAt.
      // Keep this for backward compatibility, but restrict to signed-in non-admin-panel users.
      allow update: if isSignedIn()
        && !isAdminPanelUser()
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['viewCount', 'updatedAt']);

      // No client-side delete except SUPER ADMIN
      allow delete: if isSuperAdmin();

      // Subcollection: views (reader list) – new behavior
      match /views/{viewId} {
        // Any signed-in user can mark as read
        allow create: if isSignedIn();

        // Only Super Admin can read reader list
        allow read: if isSuperAdmin();

        // No client updates/deletes
        allow update, delete: if false;
      }
    }

    // ========= announcementDrafts =========
    // Drafts in admin app.

    match /announcementDrafts/{docId} {
      // Super Admin and Admin can read/write drafts (Admin limited to own drafts by app)
      allow read, write: if isAdminPanelUser();
    }

    // ========= adminActivities =========
    // Recent activities feed in admin dashboard

    match /adminActivities/{docId} {
      allow read, write: if isAdminPanelUser();
    }

    // ========= posts =========
    // General posts from mobile app

    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();

      // Owner or any admin-panel user can update/delete
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdminPanelUser());

      match /likes/{likeId} {
        allow read, write: if isSignedIn();
      }

      match /comments/{commentId} {
        allow read, write: if isSignedIn();
      }
      
      match /comment_read/{userId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // ========= products (marketplace) =========

    match /products/{productId} {
      allow read: if isSignedIn();

      // Mobile users create listings (status: Pending)
      allow create: if isSignedIn();

      // SUPER ADMIN or seller can update/delete
      allow update, delete: if isSignedIn()
        && (isSuperAdmin() || resource.data.sellerId == request.auth.uid);

      // Legacy special case: messagesCount updates by non-seller, non-admin
      // for chat/thread counters.
      allow update: if isSignedIn()
        && !isAdminPanelUser()
        && resource.data.sellerId != request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['messagesCount', 'updatedAt']);

      match /messages/{messageId} {
        allow read, write: if isSignedIn();
      }

      match /message_read/{userId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // ========= tasks (errands) =========

    match /tasks/{taskId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();

      // SUPER ADMIN: full update/delete
      allow update, delete: if isSuperAdmin();

      // Requester or assignedTo can update, but NOT change approvalStatus
      allow update: if isSignedIn()
        && (resource.data.requesterId == request.auth.uid
            || resource.data.assignedTo == request.auth.uid)
        && request.resource.data.approvalStatus == resource.data.approvalStatus;

      // Volunteer flow: any signed-in user may update only volunteersCount and updatedAt (increment on volunteer, decrement on cancel)
      allow update: if isSignedIn()
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['volunteersCount', 'updatedAt']);

      // Participants can delete their own tasks? (Keep legacy behavior)
      allow delete: if isSignedIn()
        && (resource.data.requesterId == request.auth.uid
            || resource.data.assignedTo == request.auth.uid);

      match /volunteers/{volunteerDocId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn()
          && get(/databases/$(database)/documents/tasks/$(taskId)).data.requesterId == request.auth.uid;
        allow delete: if isSignedIn()
          && resource.data.volunteerId == request.auth.uid
          && resource.data.status == 'pending';
      }

      match /chat_messages/{messageId} {
        allow read, write: if isSignedIn()
          && (get(/databases/$(database)/documents/tasks/$(taskId)).data.requesterId == request.auth.uid
              || get(/databases/$(database)/documents/tasks/$(taskId)).data.assignedTo == request.auth.uid);
      }

      match /chat_read/{userId} {
        allow read, write: if isSignedIn()
          && request.auth.uid == userId
          && (get(/databases/$(database)/documents/tasks/$(taskId)).data.requesterId == request.auth.uid
              || get(/databases/$(database)/documents/tasks/$(taskId)).data.assignedTo == request.auth.uid);
      }
    }

    // ========= notifications =========

    match /notifications/{notificationId} {
      // Owner can read/update/delete their own notifications
      allow read, update, delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      // Users can create notifications for themselves
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      // Only Super Admin can create notifications for any user (e.g. account approval)
      allow create: if isSuperAdmin();
    }

    // ========= userAnnouncementReads =========
    // Per-user read tracking (separate from announcements/{id}/views)

    match /userAnnouncementReads/{readId} {
      allow read: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
    }
  }
}
