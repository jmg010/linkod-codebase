rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper functions =========

    function isSignedIn() {
      return request.auth != null;
    }

    // Safe accessor for current user's Firestore doc
    // Note: Only call this after checking hasUserDoc() to avoid errors
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasUserDoc() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Safe role getter - returns null if doc doesn't exist or role field is missing
    function getUserRole() {
      return hasUserDoc() ? userDoc().data.role : null;
    }

    // Role helpers (treat legacy 'admin' as super_admin)
    function role() {
      return getUserRole();
    }

    function isSuperAdmin() {
      return hasUserDoc() &&
        getUserRole() in ['super_admin', 'admin'];
    }

    function isOfficial() {
      return hasUserDoc() &&
        getUserRole() == 'official';
    }

    function isStaff() {
      return hasUserDoc() &&
        getUserRole() == 'staff';
    }

    // Any admin-panel account (can log into Windows app)
    // Optimized: check hasUserDoc once, then check role directly
    function isAdminPanelUser() {
      return hasUserDoc() &&
        getUserRole() in ['super_admin', 'admin', 'official', 'staff'];
    }

    // Legacy helper for backward compatibility (maps to admin panel users)
    function isOfficialLegacy() {
      return isAdminPanelUser();
    }

    // ========= users collection =========

    match /users/{userId} {
      // SUPER ADMIN: full access to all profiles
      allow read, write: if isSuperAdmin();

      // Owner: can read and update own profile (includes declined users re-applying: accountStatus, proofOfResidenceUrl, etc.)
      allow read, update: if isSignedIn() && request.auth.uid == userId;

      // Admin panel users (SUPER ADMIN / OFFICIAL / STAFF) can read users
      // Note: Client-side UI filters what OFFICIAL/STAFF can see (e.g., hide phone numbers, restrict to residents)
      allow read: if isAdminPanelUser();

      // OFFICIAL / STAFF:
      // - OFFICIAL: can read residents/vendors (handled on client UI),
      //   but we keep server-side simple and rely on UI restrictions.
      // - STAFF: typically read-limited via queries; we don't grant extra write power here.
      // (No extra write for them beyond owner + super_admin.)

      // Create user docs:
      // - SUPER ADMIN: can create any (official/staff/resident/vendor)
      // - Others: no direct creates (residents are usually created via backend or approval flow)
      allow create: if isSuperAdmin();

      // Devices subcollection: FCM tokens
      match /devices/{deviceId} {
        // Owner can manage own devices
        allow read, write: if isSignedIn() && request.auth.uid == userId;

        // SUPER ADMIN may need to inspect devices (optional)
        allow read: if isSuperAdmin();
      }
    }

    // ========= awaitingApproval =========
    // Sign-up / verification requests (mobile creates without Auth; admin approves later)

    match /awaitingApproval/{docId} {
      // Admin panel lists all; signed-in users can read (e.g. own request if we add requestedByUid)
      allow read: if isSignedIn();

      // Mobile create-account does NOT sign in first — allow unauthenticated create so registration works
      allow create: if true;

      // Update:
      // - Admin panel (SUPER ADMIN / OFFICIAL / STAFF) can update
      // - Applicant can update their own doc (e.g., add fcmTokens)
      allow update: if isAdminPanelUser()
        || (isSignedIn() && resource.data.requestedByUid == request.auth.uid);

      // Delete:
      // - Admin panel can delete (e.g., after approval/decline)
      allow delete: if isAdminPanelUser()
        // Applicant can delete using original email-style mapping
        || (isSignedIn()
          && request.auth.token.email == (resource.data.phoneNumber + '@linkod.com'));
    }

    // ========= announcements =========

    match /announcements/{docId} {
      // Any signed-in user can read announcements
      allow read: if isSignedIn();

      // Create:
      // - SUPER ADMIN / OFFICIAL / STAFF can create announcements
      //   (status + approval flow handled by app logic)
      allow create: if isAdminPanelUser();

      // Update:
      // - SUPER ADMIN can fully update (approve/decline, edit)
      allow update: if isSuperAdmin();

      // Special case: legacy behavior where non-admins update only viewCount/updatedAt.
      // Keep this for backward compatibility, but restrict to signed-in non-admin-panel users.
      allow update: if isSignedIn()
        && !isAdminPanelUser()
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['viewCount', 'updatedAt']);

      // No client-side delete except SUPER ADMIN
      allow delete: if isSuperAdmin();

      // Subcollection: views (reader list) – new behavior
      match /views/{viewId} {
        // Any signed-in user can mark as read
        allow create: if isSignedIn();

        // SUPER ADMIN + OFFICIAL can read reader list
        allow read: if isSuperAdmin() || isOfficial();

        // No client updates/deletes
        allow update, delete: if false;
      }
    }

    // ========= announcementDrafts =========
    // Drafts in admin app; staff can be allowed if you want them to prep drafts.

    match /announcementDrafts/{docId} {
      // SUPER ADMIN + OFFICIAL (optionally STAFF if you want)
      allow read, write: if isSuperAdmin() || isOfficial();
    }

    // ========= adminActivities =========
    // Recent activities feed in admin dashboard

    match /adminActivities/{docId} {
      allow read, write: if isAdminPanelUser();
    }

    // ========= posts =========
    // General posts from mobile app

    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();

      // Owner or any admin-panel user can update/delete
      allow update, delete: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdminPanelUser());

      match /likes/{likeId} {
        allow read, write: if isSignedIn();
      }

      match /comments/{commentId} {
        allow read, write: if isSignedIn();
      }
    }

    // ========= products (marketplace) =========

    match /products/{productId} {
      allow read: if isSignedIn();

      // Mobile users create listings (status: Pending)
      allow create: if isSignedIn();

      // SUPER ADMIN or seller can update/delete
      allow update, delete: if isSignedIn()
        && (isSuperAdmin() || resource.data.sellerId == request.auth.uid);

      // Legacy special case: messagesCount updates by non-seller, non-admin
      // for chat/thread counters.
      allow update: if isSignedIn()
        && !isAdminPanelUser()
        && resource.data.sellerId != request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['messagesCount', 'updatedAt']);

      match /messages/{messageId} {
        allow read, write: if isSignedIn();
      }
    }

    // ========= tasks (errands) =========

    match /tasks/{taskId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();

      // SUPER ADMIN: full update/delete
      allow update, delete: if isSuperAdmin();

      // Requester or assignedTo can update, but NOT change approvalStatus
      allow update: if isSignedIn()
        && (resource.data.requesterId == request.auth.uid
            || resource.data.assignedTo == request.auth.uid)
        && request.resource.data.approvalStatus == resource.data.approvalStatus;

      // Participants can delete their own tasks? (Keep legacy behavior)
      allow delete: if isSignedIn()
        && (resource.data.requesterId == request.auth.uid
            || resource.data.assignedTo == request.auth.uid);

      match /volunteers/{volunteerId} {
        allow read, write: if isSignedIn();
      }
    }

    // ========= notifications =========

    match /notifications/{notificationId} {
      // Owner can read/update/delete their own notifications
      allow read, update, delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      // Users can create notifications for themselves
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      // SUPER ADMIN / OFFICIAL can create notifications for any user
      // (e.g., account approval, important system messages)
      allow create: if isSuperAdmin() || isOfficial();
    }

    // ========= userAnnouncementReads =========
    // Per-user read tracking (separate from announcements/{id}/views)

    match /userAnnouncementReads/{readId} {
      allow read: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
    }
  }
}
